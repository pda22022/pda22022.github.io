<html>
<head>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>

  <script>
    // Component για ενεργοποίηση animation με κλικ
    AFRAME.registerComponent('testing', {
      init: function () {
        this.el.addEventListener('click', e => {
          this.el.setAttribute('animation-mixer', { timeScale: 1 });
        });
      }
    });

    // Component για τυχαία κίνηση με ομαλή περιστροφή
    AFRAME.registerComponent('random-walk', {
      schema: {
        speed: { type: 'number', default: 0.02 },
        interval: { type: 'int', default: 3000 },
        boundary: { type: 'vec2', default: { x: 50, y: 50 } },
        turnSpeed: { type: 'number', default: 0.05 } // πόσο γρήγορα γυρίζει (0-1)
      },
      init: function () {
        this.direction = new THREE.Vector3();
        this.currentRotation = 0; // σε μοίρες
        this.targetRotation = 0; // σε μοίρες
        this.pickNewDirection();
        this.lastTime = 0;
      },
      tick: function (time, timeDelta) {
        if (!this.lastTime || time - this.lastTime > this.data.interval) {
          this.pickNewDirection();
          this.lastTime = time;
        }

        // Ομαλή περιστροφή προς targetRotation
        let rotationDiff = this.targetRotation - this.currentRotation;

        // Normalize γωνία για να είναι μεταξύ -180 και 180 μοίρες
        rotationDiff = ((rotationDiff + 180) % 360) - 180;

        // Υπολογισμός μικρού βήματος περιστροφής
        const turnStep = this.data.turnSpeed * timeDelta;

        if (Math.abs(rotationDiff) < turnStep) {
          this.currentRotation = this.targetRotation;
        } else {
          this.currentRotation += turnStep * Math.sign(rotationDiff);
          this.currentRotation = (this.currentRotation + 360) % 360; // Κράτησε εντός [0,360)
        }

        // Εφαρμογή περιστροφής
        this.el.object3D.rotation.y = THREE.Math.degToRad(this.currentRotation);

        // Κίνηση προς την κατεύθυνση
        let pos = this.el.object3D.position;
        let rad = THREE.Math.degToRad(this.currentRotation);
        let dx = Math.sin(rad) * this.data.speed * timeDelta;
        let dz = Math.cos(rad) * this.data.speed * timeDelta;

        let newX = pos.x + dx;
        let newZ = pos.z + dz;

        // Έλεγχος ορίων
        if (Math.abs(newX) < this.data.boundary.x && Math.abs(newZ) < this.data.boundary.y) {
          this.el.object3D.position.set(newX, pos.y, newZ);
        } else {
          this.pickNewDirection();
        }
      },
      pickNewDirection: function () {
        let newAngle = Math.random() * 360;
        // Μπορείς να προσθέσεις περιορισμούς στο πού γυρνάει εδώ αν θέλεις
        this.targetRotation = newAngle;
      }
    });
  </script>

  <style>
    h1 { text-align: center; }
    h3 { text-align: center; }
    a-scene { width: 50%; height: 50%; border: dotted silver 3px; }
  </style>
</head>

<body>
  <h1>ΤΟ ΑΓΡΙΟ ΚΙΝΗΓΙ</h1>
  <h3>Βασίλης Δανηλάτος</h3>
  <hr />
  <p><strong>Σενάριο:</strong>...</p>
  <hr />
<div align="center">

  <a-scene id="s1" cursor="rayOrigin: mouse" background="color:PowderBlue" ondblclick="this.requestFullscreen();" embedded>
    <a-camera><a-cursor fuse="true" fuse-timeout="5000"></a-cursor></a-camera>
    <a-sphere radius="500" position="0 5000 0" material="fog: false"></a-sphere>

    <a-entity position="0 250 0" light="type: directional; intensity: 0.5; castShadow: true;
        shadowCameraBottom: -500; shadowCameraTop: 500; shadowCameraLeft: -500; shadowCameraRight: 500">
    </a-entity>

    <a-light type="ambient" intensity="0.25"></a-light>
    <a-plane color="PaleGoldenrod" static-body height="1000" width="1000" rotation="-90 0 0"></a-plane>

    <a-assets>
      <a-asset-item id="bank" src="western_bank.glb"></a-asset-item>
      <a-asset-item id="watertower" src="western_watertower.glb"></a-asset-item>
      <a-asset-item id="church" src="western_church.glb"></a-asset-item>
      <a-asset-item id="tree" src="tree.glb"></a-asset-item>
      <a-asset-item id="building" src="western_building.glb"></a-asset-item>
      <a-asset-item id="tobacco" src="western_tobacco.glb"></a-asset-item>
      <a-asset-item id="Running" src="Running.glb"></a-asset-item>
    </a-assets>

    <!-- Κτίρια -->
    <a-entity gltf-model="#bank" scale="2 2 2" position="-1 -0.4 -20"></a-entity>
    <a-entity gltf-model="#building" scale="50 50 50" position="-35 0.9 -20"></a-entity>
    <a-entity gltf-model="#tobacco" scale="3 3 3" position="-20 -0.2 -20" rotation="0 -90 0"></a-entity>
    <a-entity gltf-model="#watertower" scale="2 3 2" position="25 57 -20"></a-entity>
    <a-entity gltf-model="#church" scale="2 2 2" position="-60 0.9 20" rotation="0 -180 0"></a-entity>
    <a-entity gltf-model="#building" scale="50 50 50" position="-15 0.9 20" rotation="0 -180 0"></a-entity>
    <a-entity gltf-model="#building" scale="50 50 50" position="15 0.9 20" rotation="0 -180 0"></a-entity>
    <a-entity gltf-model="#building" scale="50 50 50" position="30 0.9 20" rotation="0 -180 0"></a-entity>

    <!-- Χαρακτήρας που κινείται τυχαία με ομαλή περιστροφή -->
    <a-entity id="runner"
              gltf-model="#Running"
              scale="0.3 0.3 0.3"
              animation-mixer="clip: *; loop: repeat"
              testing
              position="10 0 0"
              random-walk="speed: 0.02; interval: 4000; boundary: 50 50; turnSpeed: 0.1">
    </a-entity>

    <!-- Δέντρα -->
    <script>
      var scene1 = document.getElementById('s1');
      var treeCount = 40;
      var innerRadius = 60;
      var outerRadius = 80;

      for (var i = 0; i < treeCount; i++) {
        var tree = document.createElement('a-entity');
        var angle = Math.random() * 2 * Math.PI;
        var radius = innerRadius + Math.random() * (outerRadius - innerRadius);
        var x = Math.cos(angle) * radius;
        var z = Math.sin(angle) * radius;
        var s = 0.1;
        var r = Math.random() * 180 - 90;

        tree.setAttribute('gltf-model', '#tree');
        tree.setAttribute('position', `${x} 0 ${z}`);
        tree.setAttribute('scale', `${s} ${s} ${s}`);
        tree.setAttribute('rotation', `0 ${r} 0`);
        tree.setAttribute('shadow', 'receive: false');

        scene1.appendChild(tree);
      }
    </script>
  </a-scene>
</div>
  <hr />
  <p><strong>Οδηγίες:</strong>...</p>
  <hr />
  <p><strong>Credits:</strong></p>
</body>
</html>
